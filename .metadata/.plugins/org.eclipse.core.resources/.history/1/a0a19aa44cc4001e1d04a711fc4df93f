package ecommerce.controllers;

import java.util.ArrayList;
import java.util.List;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.CrossOrigin;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import ecommerce.dto.ProductDTO;
import ecommerce.entities.ProductEntity;
import ecommerce.entities.ProductOrderEntity;
import ecommerce.services.ProductService;

@RestController
@CrossOrigin(origins = {"http://localhost:4200", "http://127.0.0.1:4200", "http://localhost:8080"})

@RequestMapping("/ecommerce/product")
public class ProductController {

    @Autowired
    private ProductService productService;

    @GetMapping
    public List<ProductDTO> listProduct() {
        List<ProductEntity> productEntities = productService.getAllProduct();
        return convertToDTOs(productEntities);
    }

    @GetMapping("/{id}")
    
    public ResponseEntity<ProductDTO> getProductById(@PathVariable Long productId) {
        ProductEntity productEntity = productService.getProductById(productId);

        if (productEntity != null) {
            List<Long> orderIds = convertToOrderIds(productEntity.getProductOrders());

            ProductDTO dto = new ProductDTO(
                productEntity.getId_product(),
                productEntity.getProduct_name(),
                productEntity.getDescription(),
                productEntity.getPrice(),
                productEntity.getStock_quantity(),
                productEntity.getCategory(),
                productEntity.getCreation_date(),
                productEntity.getUpdate_date(),
                productEntity.getDiscount(),
                productEntity.getTaxes(),
                productEntity.getProduct_image(),
                productEntity.getAvailability(),
                productEntity.getTechnical_specifications(),
                orderIds
            );

            return new ResponseEntity<>(dto, HttpStatus.OK);
        } else {
            return new ResponseEntity<>(HttpStatus.NOT_FOUND);
        }
    }
    
    
    
    
    
    
    
    private List<ProductDTO> convertToDTOs(List<ProductEntity> productEntities) {
        List<ProductDTO> productDTOs = new ArrayList<>();

        for (ProductEntity entity : productEntities) {
            List<Long> orderIds = convertToOrderIds(entity.getProductOrders());

            ProductDTO dto = new ProductDTO(
                entity.getId_product(),
                entity.getProduct_name(),
                entity.getDescription(),
                entity.getPrice(),
                entity.getStock_quantity(),
                entity.getCategory(),
                entity.getCreation_date(),
                entity.getUpdate_date(),
                entity.getDiscount(),
                entity.getTaxes(),
                entity.getProduct_image(),
                entity.getAvailability(),
                entity.getTechnical_specifications(),
                orderIds
            );

            productDTOs.add(dto);
        }

        return productDTOs;
    }

    private List<Long> convertToOrderIds(List<ProductOrderEntity> productOrderEntities) {
        List<Long> orderIds = new ArrayList<>();
        for (ProductOrderEntity productOrderEntity : productOrderEntities) {
            Long orderId = productOrderEntity.getPurchase_order().getId_order();
            orderIds.add(orderId);
        }

        System.out.println("El array tiene: " + orderIds);
        return orderIds;
    }
}