package ecommerce.controllers;

import java.util.ArrayList;
import java.util.List;
import java.util.Optional;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.CrossOrigin;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import ecommerce.dto.ProductDTO;
import ecommerce.entities.ProductEntity;
import ecommerce.entities.ProductOrderEntity;
import ecommerce.services.ProductService;

@RestController
@CrossOrigin(origins = {"http://localhost:4200", "http://127.0.0.1:4200", "http://localhost:8080","http://127.0.0.1:8080"})

@RequestMapping("/ecommerce/product")
public class ProductController {

    @Autowired
    private ProductService productService;

    @GetMapping
    public List<ProductDTO> listProduct() {
        List<ProductEntity> productEntities = productService.getAllProduct();
        return convertToDTOs(productEntities);
    }

    @GetMapping("/{productId}")
    public ResponseEntity<?> getProductById(@PathVariable Long productId) {
        Optional<P> productById = productService.getProductById(productId);

        if (productById.isPresent()) {
            return new ResponseEntity<>(productById.get(), HttpStatus.OK);
        } else {
            return new ResponseEntity<>("Producto no encontrado", HttpStatus.NOT_FOUND);
        }
    }
    
    
    
    
    
    
    
    private List<ProductDTO> convertToDTOs(List<ProductEntity> productEntities) {
        List<ProductDTO> productDTOs = new ArrayList<>();

        for (ProductEntity entity : productEntities) {
            List<Long> orderIds = convertToOrderIds(entity.getProductOrders());

            ProductDTO dto = new ProductDTO(
                entity.getId_product(),
                entity.getProduct_name(),
                entity.getDescription(),
                entity.getPrice(),
                entity.getStock_quantity(),
                entity.getCategory(),
                entity.getCreation_date(),
                entity.getUpdate_date(),
                entity.getDiscount(),
                entity.getTaxes(),
                entity.getProduct_image(),
                entity.getAvailability(),
                entity.getTechnical_specifications(),
                orderIds
            );

            productDTOs.add(dto);
        }

        return productDTOs;
    }

    private List<Long> convertToOrderIds(List<ProductOrderEntity> productOrderEntities) {
        List<Long> orderIds = new ArrayList<>();
        for (ProductOrderEntity productOrderEntity : productOrderEntities) {
            Long orderId = productOrderEntity.getPurchase_order().getId_order();
            orderIds.add(orderId);
        }

        System.out.println("El array tiene: " + orderIds);
        return orderIds;
    }
}